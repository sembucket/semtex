%%
%% This is file `bibtopic.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% bibtopic.dtx  (with options: `package')
%% 
%% LaTeX package for structured bibliographies
%% 
%% Copyright (C) 1998-2000 P. Basso, S. Ulrich
%% This program is free software; you can redistribute it and/or
%% modify it under the terms of the GNU General Public License
%% as published by the Free Software Foundation; either version 2
%% of the License, or (at your option) any later version.
%% 
%% This program is distributed in the hope that it will be useful,
%% but WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%% GNU General Public License for more details.
%% 
%% You should have received a copy of the GNU General Public License
%% along with this program; if not, write to the Free Software
%% Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
%% 
\NeedsTeXFormat{LaTeX2e}[1996/12/01]
\ProvidesPackage{bibtopic}[2000/08/22 v1.0f Sectioned Bibliographies]
\newcommand*\bt@info{\@gobble}
\newcommand*\bt@infoNoLine{\@gobble}
\newcommand\bt@gobblethree[3]{}
\newcommand\bt@temp{}
\newif\if@bt@koma@
\newif\if@bt@natbib@
\newif\if@bt@brf@
\newif\if@bt@after@brf@
\newif\if@bt@elem@
\newif\if@bt@inside@sect@
\newif\if@bt@inside@unit@
\newif\if@bt@fast@\global\@bt@fast@true
\newif\if@bt@normalwarnings@
\newif\if@bt@breakcites@
\newif\if@bt@part@cont@ctr@
\newif\if@bt@sectctr@reset@
\newif\if@bt@btunits@
\newif\if@bt@printheadings@
\newif\if@bt@cont@
\newif\if@bt@found@item@
\newif\if@bt@print@positive@
\newif\if@bt@print@all@
\newif\if@globalbiblio
\newif\if@bt@fallback@thb@
\newif\if@bt@warn@override@ \@bt@warn@override@true
\newif\if@bt@override@numargs@ \@bt@override@numargs@true
\newcommand\bt@stepcnt[1]{%
     \@tempcnta#1
     \advance\@tempcnta\@ne
     \protected@xdef#1{\the\@tempcnta}%
}
\newcounter{btauxfile}
\def\thebtauxfile{\jobname\arabic{btauxfile}}
\newcommand\bt@unit@cnt{1}
\newcommand\bt@internal@sect@cnt{0}
\newcommand\bt@harvard@errs{0}
\newcommand\bt@overridden@nums{0}
\newcommand\bt@helpctr{0}
\newcommand\bt@totalctr{0}
\newread\bt@infilea
\newread\bt@infileb
\newwrite\bt@outfile

\DeclareOption{btunits}{%
    \def\bibcite#1#2{%
      \global\@namedef{b@#1\@extra@binfo}{#2}%
    }%
    \global\@bt@btunits@true
}
\DeclareOption{defaultbib}{%
    \global\@bt@fallback@thb@true
}
\DeclareOption{verbose}{%    
    \def\bt@info#1{%
        \begingroup
            \def\MessageBreak{^^J(bibtopic)\@spaces\@spaces\@spaces}%
            \set@display@protect
            \immediate\write\@unused{%
                ^^JPackage bibtopic info: #1\on@line.^^J%
            }%
        \endgroup
    }%
    \def\bt@infoNoLine#1{%
        \begingroup
            \def\MessageBreak{^^J(bibtopic)\@spaces\@spaces\@spaces}%
            \set@display@protect
            \immediate\write\@unused{%
                ^^JPackage bibtopic info: #1.^^J%
            }%
        \endgroup
    }%
}
\DeclareOption{breakcites}{%
    \global\@bt@breakcites@true
}
\DeclareOption{normalwarnings}{%
    \global\@bt@normalwarnings@true
}
\DeclareOption{printheadings}{%
    \global\@bt@printheadings@true
}
\DeclareOption{unitcntnoreset}{%
    \global\@bt@part@cont@ctr@true
}
\DeclareOption{sectcntreset}{%
    \global\@bt@sectctr@reset@true
}
\DeclareOption{slow}{%
    \global\@bt@fast@false
}
\DeclareOption{dot}{%
   \def\thebtauxfile{\jobname.\arabic{btauxfile}}%
}
\DeclareOption{overridenumbers}{%
    \@bt@warn@override@false
}
\DeclareOption{dontoverridenumbers}{%
    \@bt@override@numargs@false
}
\ProcessOptions*

\newcommand\bt@if@isnum[1]{%
    \if!\ifnum9<1#1!\else_\fi
        \expandafter\@firstoftwo
    \else
        \expandafter\@secondoftwo
    \fi
}

\newcommand*\bt@sect@ref@list{}
\newcommand\bt@curr@file{}
\newcommand\bt@curr@line{}
\newcommand*\bt@kv@req@list{}

\newcommand*\bt@curr@bib@file{}
\newcommand*\bt@cited@list{}
\newcommand*\bt@warn@files{}
\newcommand*\bt@label{}
\newcommand*\bt@globalstyle{}%
\newcommand*\bt@defaultstyle{plain}%
\newcommand*{\@bt@oldcitation}{}
\let\@bt@oldcitation\citation
\if@bt@fast@
   \def\citation#1{%
      \@for\bt@temp:=#1\do{%
        \def\@extra@b@citeb{\bt@unit@cnt}%
        \global\@namedef{\bt@temp bt@\@extra@binfo}{}%
        \@bt@oldcitation{\bt@temp}%
      }%
   }%
\else
   \def\citation#1{%
      \@for\bt@temp:=#1\do{%
        \def\@extra@b@citeb{\bt@unit@cnt}%
        \bt@add@elem{\bt@temp}{\bt@cited@list}%
        \@bt@oldcitation{\bt@temp}%
      }%
   }%
\fi
\newcommand*\bt@citesurround{}%

\def\bt@citesurround{%
    \if@bt@breakcites@
        \relax
    \else
        \hbox
    \fi
}
\@ifundefined{citeform}{\let\citeform\relax}{}
\@ifundefined{citepunct}{\def\citepunct{,\penalty\@m\ }}{}
\@ifpackageloaded{backref}{%
    \@bt@after@brf@true
}{%
    \relax
}
\newcommand\bt@citex{}
\def\bt@citex[#1]#2{%  Add \@extra@b@citeb to \cite
    \let\@citea\@empty
    \@cite{%
        \@for\@citeb:=#2\do{%
            \@citea\let\@citea\citepunct
            \edef\@citeb{\expandafter\@firstofone\@citeb}%
            \if@filesw\immediate\write\@auxout{%
                \string\citation{\@citeb}}\fi
            \@ifundefined{b@\@citeb \@extra@b@citeb}{%
                \mbox{\reset@font\bfseries ?}%
                \@warning{Citation `\@citeb' on page \thepage\space
                undefined}\G@refundefinedtrue
            }{%
                \bt@citesurround{\citeform{\csname b@\@citeb
                \@extra@b@citeb\endcsname}}%
            }%
        }%
    }{#1}%
}

\newcommand\bt@nocite{}
\def\bt@nocite#1{%
    \@bsphack % Add \@extra@b@citeb to \nocite
    \@for\@citeb:=#1\do{%
        \edef\@citeb{\expandafter\@firstofone\@citeb}%
        \if@filesw
            \immediate\write\@auxout{%
                \string\citation{\@citeb}%
            }%
        \fi
        \@ifundefined{b@\@citeb\@extra@b@citeb}{%
            \G@refundefinedtrue
            \@warning{Citation `\@citeb'  undefined}%
        }{}%
    }%
    \@esphack
}

\newcommand*\bt@setcites{%
    \let\@citex\bt@citex
    \let\nocite\bt@nocite
}

\gdef\the@ipfilectr{}
\def\@extra@b@citeb{\the@ipfilectr}
\gdef\@extra@binfo{}  % in case .aux files are left from old run.

\newcommand\bt@saveitem{}
\newcommand*\bt@savebib{}
\newcommand*\bt@endsavebib{}

\AtBeginDocument{%
    \global\let\bt@savebib\thebibliography
    \global\let\bt@endsavebib\endthebibliography
    \let\bt@saveitem\bibitem
    \@ifpackageloaded{natbib}{%
        \global\@bt@natbib@true
    }{%
        \def\harvarditem{\gdef\bt@harvard@errs{1}}%
        \let\harvardand\relax
        \let\harvardyearleft\relax
        \let\harvardyearright\relax
    }%
    \@ifpackageloaded{backref}{%
        \if@bt@after@brf@\else
            \PackageError{%
                bibtopic%
            }{%
                Load bibtopic after hyperref when using the `backref'
                option\MessageBreak of hyperref%
            }{%
                Please see the section about `Compatibility with
                other\MessageBreak packages' in bibtopic.dvi for
                details.
            }%
        \fi
        \global\@bt@brf@true
    }{%
        \relax
    }%
    \@ifclassloaded{scrbook}{%
        \global\@bt@koma@true
    }{%
        \@ifclassloaded{scrreprt}{%
            \global\@bt@koma@true
        }{%
            \@ifclassloaded{scrartcl}{%
                \global\@bt@koma@true
            }{%
            }%
        }%
    }%
}

\AtEndDocument{%
    \immediate\write\@auxout{%
        \string\csname\space bt@set@cnt\string\endcsname{\bt@helpctr}}%
    \def\citation#1{\@bt@oldcitation{#1}}%
    \let\bt@addto@keyval@list\bt@gobblethree
    \bt@files@warnings
    \ifnum\bt@helpctr=\bt@totalctr\else
        \PackageWarningNoLine{%
            bibtopic%
        }{%
            Rerun to get indentation of bibitems right%
        }%
    \fi
}
\newcommand*\bt@savelist{}
\newcommand*\bt@append@list[2]{%
    \let\bt@savelist#2
    \protected@xdef#2{\bt@savelist\@elt{#1}}%
}
\newcommand*\bt@add@elem[2]{%
    \@bt@elem@false
    \bt@testelem{#1}{#2}%
    \if@bt@elem@
    \else
        \bt@append@list{#1}{#2}%
    \fi
}
\newcommand*\bt@testelem[2]{%
    \@bt@elem@false
    \begingroup
    \protected@edef\@tempa{#1}%
    \def\@elt##1{%
        \protected@edef\@tempb{##1}%
        \ifx\@tempa\@tempb\global\@bt@elem@true\fi
    }%
    #2%
    \endgroup
}
\newcommand*\bt@mk@warning@list[1]{%
    \@temptokena={}%
    \let\@@elt=\@elt
    \def\@elt##1{%
        \@temptokena=\expandafter{\the\@temptokena ##1\MessageBreak}%
    }%
    #1%
    \let\@elt\@@elt
}

\newcommand*\@orig@bibliographystyle{}
\let\@orig@bibliographystyle\bibliographystyle
\def\bibliographystyle#1{%
    \gdef\bt@globalstyle{#1}%
    \bt@info{Default bibliographystyle is `#1'}%
    \@orig@bibliographystyle{#1}%
}
\def\bibliography{%
    \PackageInfo{%
        bibtopic%
    }{%
        The command `\string\bibliography' was ignored\MessageBreak
    }%
    \@gobble
}

\newcommand*\@bt@write@auxfile[3]{%
    \bt@make@backup{\thebtauxfile}%    
    \immediate\openout\bt@outfile\thebtauxfile.aux
    \if@bt@natbib@
        \immediate\write\bt@outfile{%
                \@percentchar\@percentchar\space
                Info from `bibtopic.sty': natbib loaded.^^J%
                \string\bibstyle{#1}^^J%
                \string\citation{#2}^^J%
                \string\bibdata{#3}%
        }%
    \else
        \immediate\write\bt@outfile{%
            \string\bibstyle{#1}^^J%
            \string\citation{#2}^^J%
            \string\bibdata{#3}%
        }%
    \fi
    \immediate\closeout\bt@outfile
    \bt@cmp{\thebtauxfile}%
}
\newcommand*\bt@mark@as@outdated[1]{%
    \bt@appendtofile{#1.bbl}{\string\BToutdated{#1}}%
}
\newcommand*\BToutdated[1]{%
    \bt@warn@outd{#1}%
}
\newcommand*\bt@appendtofile[2]{%
    \bt@copy@verbatim{#1}{bbl.tmp}%
    \bt@closeout
    \bt@copy@verbatim{bbl.tmp}{#1}
    \immediate\write\bt@outfile{\expandafter\string #2}%
    \bt@closeout
}

\newenvironment{bt@sect}[2]{%
    \gdef\bt@curr@bib@file{#2}%
    \gdef\bt@sect@ref@list{}%    
    \bt@change@thb%
    \if@filesw
        \@bt@write@auxfile{#1}{*}{#2}%
    \fi
}{%
    \relax
}
\newcommand*\bt@empty@list{%
    \def\bt@cited@list{}%
}
\newcommand*\bt@save@list[1]{%
    \expandafter\protected@xdef\csname bt@sect%
       \romannumeral#1\endcsname{\bt@cited@list}%
}
\newcommand\btBegThbCmd{}
\newcommand*\bt@change@bibitem{%
    \expandafter\ifx\btBegThbCmd\empty\else
            \bt@info{\string\btBegThbCmd nonempty: \meaning\btBegThbCmd}%
    \fi
    \def\bt@beg@thb@hook{\btBegThbCmd\global\@bt@found@item@false\bt@item{}}%
    \def\bt@end@thb@hook{\endbt@item\bt@bibitemcheck}%
    \if@bt@natbib@
        \def\harvarditem{\endbt@item\bt@harvitem}%
    \fi
    \def\bibitem{\endbt@item\bt@item}%
}
\newcommand*\bt@adjust@label[1]{%
    \protected@edef\@tmptest{#1}%
    \bt@if@isnum{\@tmptest}{%
        \def\bt@label{\bt@totalctr}%
    }{%
        \def\bt@label{#1}%
    }%
}
\newcommand*\bt@change@thb{%
    \long\def\@tempa##1##2\endthebibliography{%
        \def\@tempc{##1}%
    }%
    \expandafter\@tempa\thebibliography{}\endthebibliography
    \if@bt@brf@
        \@ifundefined{BRorg@thebibliography}{%
            \PackageInfo{bibtopic}{assuming backref.sty <= v1.16}%
            \let\bt@brf@bbl@cmd\oldbibl
        }{%
            \PackageInfo{bibtopic}{assuming backref.sty >= v1.19}%
            \let\bt@brf@bbl@cmd\BRorg@thebibliography
        }%
        \def\@tempb{\@starttoc}%
        \ifx\@tempb\@tempc
            \expandafter\@tempa\bt@brf@bbl@cmd{}\endthebibliography
        \fi
    \fi
    \def\@tempa{\bibfont}%
    \ifx\@tempa\@tempc %
        \bt@change@nat@thb
    \else
        \def\@tempa{\bibsection}%
        \ifx\@tempa\@tempc
            \bt@change@nat@thb
        \else
            \def\@tempa{\bib@heading}%
            \ifx\@tempa\@tempc
                \bt@change@KOMA@thb
            \else
                \def\@tempa{\chapter}%
                \ifx\@tempa\@tempc
                    \bt@change@standard@thb
                \else
                    \def\@tempa{\section}%
                    \ifx\@tempa\@tempc
                    \bt@change@standard@thb
                    \else
                        \if@bt@fallback@thb@
                            \PackageWarning{%
                                bibtopic%
                            }{%
                                `defaultbib' specified; using
                                built-in\MessageBreak
                                `thebibliography' environment%
                            }%
                            \let\thebibliography\bt@dflt@bthb
                            \let\endthebibliography\bt@dflt@ethb
                        \else
                            \PackageError{%
                                bibtopic%
                            }{%
                                Found unknown `thebibliography' environment%
                            }{%
                                You should either use a package providing
                                a known bibliography\MessageBreak
                                environment (such as natbib), or use the
                                `defaultbib' package\MessageBreak option
                                as a workaround; please see the section
                                about `Warnings\MessageBreak and error
                                messages' in `bibtopic.dvi' for
                                details.\MessageBreak
                            }%
                        \fi
                    \fi
                \fi
            \fi
        \fi
    \fi
}

\providecommand\@openbib@code{}
\newcommand\bt@dflt@bthb[1]{%
    \bt@adjust@label{#1}%
    \if@bt@printheadings@
    \@ifundefined{chapter}{%
        \@ifundefined{section}{%
            \@startsection{section}{1}{\z@}%
                {-3.5ex \@plus -1ex \@minus -.2ex}%
                {2.3ex \@plus.2ex}%
                {\normalfont\Large\bfseries}*{\refname}%
        }{%
            \section*{\refname\@mkboth{\refname}{\refname}}%
        }%
    }{%
        \chapter*{\bibname\@mkboth{\bibname}{\bibname}}%
    }%
    \fi
    \list{\@biblabel{\@arabic\c@enumiv}}{%
        \settowidth\labelwidth{\@biblabel{#1}}%
        \leftmargin\labelwidth
        \advance\leftmargin\labelsep
        \@openbib@code
        \if@bt@sectctr@reset@
            \usecounter{enumiv}%
        \else
            \@nmbrlisttrue
            \def\@listctr{enumiv}%
        \fi
        \let\p@enumiv\@empty
        \renewcommand*\theenumiv{\@arabic\c@enumiv}%
    }%
    \sloppy\clubpenalty4000\widowpenalty4000%
    \sfcode`\.=\@m
    \bt@beg@thb@hook
}%

\newcommand\bt@dflt@ethb{%
    \bt@end@thb@hook
    \def\@noitemerr{%
        \@latex@warning{Empty `thebibliography' environment}%
    }%
    \endlist
}%

\newcommand\bt@change@nat@thb{%
    \def\thebibliography##1{%
           \bt@adjust@label{##1}%
           \if@bt@sectctr@reset@
           \else
               \def\setcounter####1####2{%
                   \relax
               }%
           \fi
           \if@bt@printheadings@\else
               \let\bibsection\relax
           \fi
           \bt@savebib{\bt@label}%    
           \bt@beg@thb@hook
    }%
    \def\endthebibliography{%
       \bt@end@thb@hook
       %   \bt@endsavebib %% not; define it explicitly instead:
       \def\@noitemerr{%
           \PackageWarning{%
              bibtopic%
           }{%
              Empty `thebibliography' environment%
           }%
       }%
       \endlist % \vskip-\lastskip omitted here
    }%
}

\newcommand*\bt@change@standard@thb{%
    \def\thebibliography##1{%
        \bt@adjust@label{##1}%
        \if@bt@sectctr@reset@
        \else
            \def\usecounter####1{%
                \@nmbrlisttrue
                \def\@listctr{####1}%
            }%
        \fi
        \if@bt@printheadings@\else
            \let\chapter\@gobbletwo
            \let\section\@gobbletwo
        \fi
        \bt@savebib{\bt@label}%
        \bt@beg@thb@hook
    }%
    \def\endthebibliography{\bt@end@thb@hook\bt@endsavebib}%
}
\newcommand*\bt@change@KOMA@thb{%
    \if@bt@printheadings@\else
        \let\bib@heading\relax
    \fi
    \if@bt@koma@\else
        \PackageWarningNoLine{%
            bibtopic%
        }{%
            Found KOMA-like bibliography, but no KOMA class\MessageBreak
            (I'll assume you know what you're doing ...;)%
        }%
        \global\@bt@koma@true
    \fi
    \bt@change@standard@thb
}

\newcommand\bt@harvitem{%
    \expandafter\@ifnextchar\lbrack{\bt@@harvitem}{\bt@@harvitem[]}%
}

\newcommand*\bt@@harvitem[4][]{%
    \if!#1!
        \protected@xdef\@args{[#2(#3)]}%
    \else
        \bt@warn@brackets{#2}#1[]\end%
        \protected@xdef\@args{[#1(#3)#2]}%
    \fi
    \bt@call@item{#4}%
}
\newcommand*\bt@item{}
\def\bt@item{%
    \expandafter\@ifnextchar\lbrack{\bt@@item}{\bt@@item[]}%
}
\newcommand*\bt@@item[2][]{%
    \if!#1!
        \gdef\@args{}%
    \else
        \protected@edef\@tmptest{#1}%
        \bt@if@isnum{\@tmptest}{%
            \if@bt@override@numargs@ %   
                \if@bt@warn@override@
                    \gdef\bt@overridden@nums{1}%
                \fi
                \gdef\@args{}%
            \else
                \bt@warn@brackets{#2}#1[]\end%
                \protected@xdef\@args{[#1]}%
            \fi
        }{%
            \bt@warn@brackets{#2}#1[]\end%
            \protected@xdef\@args{[#1]}%
        }%
    \fi
    \bt@call@item{#2}%
}
\newcommand*\bt@warn@brackets{}
\def\bt@warn@brackets#1#2[#3]#4\end{%
    \if!#3!
    \else
        \PackageError{%
            bibtopic%
        }{%
            Can't parse brackets in key `#1' properly%
        }{%
            You seem to have used brackets `[]' inside that key
            in\MessageBreak `\bt@curr@bib@file.bib', and I may have
            confused these with\MessageBreak the optional argument of
            the `\string\bibitem' command. To avoid\MessageBreak this,
            please `hide' such brackets in an extra pair of
            braces,\MessageBreak like this: `{[]}'.\MessageBreak
            (Don't forget to rerun BibTeX on `\thebtauxfile'
            afterwards.)\MessageBreak If you proceed now, your
            bibliograpy might look somewhat garbled.\MessageBreak
        }%
    \fi
}

\newcommand*\bt@boxing@hook{\let\@noitemerr\relax}

\newcommand*\bt@call@item{}
\if@bt@fast@
   \def\bt@call@item#1{%
       \if!#1!
           \gdef\@gtempa{\begin{lrbox}{\@tempboxa}\bt@boxing@hook}%
           \gdef\@gtempb{\end{lrbox}}%
       \else
           \gdef\@gtempa{\expandafter\bt@saveitem\@args{#1}}%
           \global\let\@gtempb\relax
           \expandafter\ifx\csname #1bt@\@extra@b@citeb\endcsname\relax
               \bt@print@non@positive{#1}%
           \else
               \bt@print@positive{#1}%
           \fi
       \fi
       \@gtempa
   }
\else
   \def\bt@call@item#1{%
       \if!#1!
           \gdef\@gtempa{\begin{lrbox}{\@tempboxa}\bt@boxing@hook}%
           \gdef\@gtempb{\end{lrbox}}%
       \else
           \gdef\@gtempa{\expandafter\bt@saveitem\@args{#1}}%
           \global\let\@gtempb\relax
           \@bt@elem@false
           \bt@testelem{#1}{\csname bt@sect\romannumeral\bt@unit@cnt\endcsname}%
           \if@bt@elem@
               \bt@print@positive{#1}%
           \else % \if@bt@elem@
               \bt@print@non@positive{#1}%
           \fi
       \fi
       \@gtempa
   }
\fi

\newcommand*\bt@print@positive[1]{%
    \if@bt@print@positive@
        \global\@bt@found@item@true
        \bt@stepcnt\bt@helpctr
        \@bt@elem@false
        \bt@testelem{#1}{\bt@kv@req@list}%
        \if@bt@elem@
            \bt@add@elem{#1}{\bt@sect@ref@list}%    
        \fi
    \else
        \if@bt@print@all@
            \global\@bt@found@item@true
            \bt@stepcnt\bt@helpctr
            \@bt@elem@false
            \bt@testelem{#1}{\bt@kv@req@list}%
            \if@bt@elem@
                \bt@add@elem{#1}{\bt@sect@ref@list}%
            \fi
        \else
            \gdef\@gtempa{\begin{lrbox}{\@tempboxa}\bt@boxing@hook}%
            \gdef\@gtempb{\end{lrbox}}%% was: gdef
        \fi
    \fi
}
\newcommand*\bt@print@non@positive[1]{%
    \if@bt@print@positive@
        \gdef\@gtempa{\begin{lrbox}{\@tempboxa}\bt@boxing@hook}%
        \gdef\@gtempb{\end{lrbox}}%
    \else
        \bt@stepcnt\bt@helpctr
        \global\@bt@found@item@true
        \@bt@elem@false
        \bt@testelem{#1}{\bt@kv@req@list}%
        \if@bt@elem@
            \bt@add@elem{#1}{\bt@sect@ref@list}%    
        \fi
    \fi
}

\def\endbt@item{%
    \@gtempb
}
\newcommand\bt@copy@verbatim[2]{%
    \openin\bt@infilea=#1\relax
    \immediate\openout\bt@outfile=#2\relax
    \begingroup
        \let\do\@makeother \dospecials
        \endlinechar\m@ne
        \ifeof\bt@infilea
            \bt@info{Tried to copy #1, but couldn't find it}%
        \else
            \loop
                \read\bt@infilea to\@tempa
                % same trick as with \if!...!
                \if\ifeof\bt@infilea 0\else 1\fi 1
                \immediate\write\bt@outfile{\@tempa}%
            \repeat
        \fi
    \endgroup
    \closein\bt@infilea
}

\newcommand*\bt@closeout{%
    \immediate\closeout\bt@outfile
}

\newcommand*\bt@make@backup[1]{%
    \bt@copy@verbatim{#1.aux}{#1.bak}%
    \bt@closeout
}

\newcommand*\bt@cmp[1]{%    
    \gdef\@gtempa{0}%
    \bgroup
        \let\do\@makeother \dospecials
        \endlinechar-1
        \openin\bt@infilea=#1.aux
        \openin\bt@infileb=#1.bak
        \@bt@cont@true
        \loop
        \ifeof\bt@infilea
            \@bt@cont@false
            \ifeof\bt@infileb
            \else
                \gdef\@gtempa{1}%
            \fi
        \else
            \ifeof\bt@infileb
                \@bt@cont@false\gdef\@gtempa{1}%
            \fi
        \fi
        \if@bt@cont@
            \read\bt@infilea to\@tempa
            \read\bt@infileb to\@tempb
            \ifx\@tempa\@tempb
            \else
                \gdef\@gtempa{1}\@bt@cont@false
            \fi
        \repeat
        \closein\bt@infilea
        \closein\bt@infileb
    \egroup
    \bt@print@res@cmp{#1}{\@gtempa}%
}

\newcommand*\bt@print@res@cmp[2]{%
    \ifcase#2
        \let\@tempa\relax
    \or
        \def\@tempa{%
            \bt@warn@diff{#1}%    
        }%
    \fi
    \@tempa
}
\newcommand*\bt@set@cnt[1]{%
    \gdef\bt@totalctr{#1}%
}

\newcommand*\bt@old@keyval@list{}

\newcommand*\bt@kv@add[2]{%
    \bt@addto@keyval@list{#1}{#2}{\bt@old@keyval@list}%
}

\DeclareRobustCommand\btCiteSect[1]{%
    \btGetVal{#1}%
    \cite{#1} (section\nobreakspace{}\ref{\btretval})%
}

\newcommand*\btRef[2]{%
    % get section label of #1 from \bt@keyval@list
    % reference type is #2
    \ifx\bt@old@keyval@list\@undefined
        {\bfseries{???}}%
    \else
        \bt@get@keyval{#1}{\bt@old@keyval@list}%
        #2{\btretval}%
    \fi
}

\DeclareRobustCommand\btGetVal[1]{%
    \bt@get@keyval{#1}{\bt@old@keyval@list}%
}
\newcommand*\bt@warn@retval[1]{%
    \PackageWarning{bibtopic}%
    {Key `#1' not found\MessageBreak in list of cited works}%
}
\newcommand*\bt@keyval@list{}
\newcommand*\bt@print@keyvals[2]{%
    \let\@@elt\@elt%
    \def\@elt##1{%
        \protected@write\@auxout{}{%
            \string\bt@kv@add{##1}{#2}%
        }%
    }#1%
    \let\@elt\@@elt
}
\newcommand*\bt@addto@keyval@list[3]{%
    \@temptokena\expandafter{#3}%
    \protected@xdef#3{\noexpand\@elt{#1}{#2}\the\@temptokena}%
}
\newcommand*\bt@get@keyval[2]{%
    \bt@add@elem{#1}{\bt@kv@req@list}%
    %% get value of key #1 from list #2
    \protected@edef\@tempa{#1}%
    \@bt@elem@false
    \let\@@elt\@elt%
    \def\@elt##1##2{\def\@tempb{##1}%
        \ifx\@tempa\@tempb  %##2
            \@bt@elem@true
            \gdef\btretval{##2}%
        \fi
    }%
    #2%
    \let\@elt\@@elt
    \if@bt@elem@\else
        \gdef\btretval{???}%
        \bt@warn@retval{#1}%
    \fi
}

\newcommand*\bt@get@label[2]{%
    \protected@edef\@tempa{#1}%
    \let\@@elt\@elt%
    \def\@elt##1##2{\def\@tempb{##1}%
        \ifx\@tempa\@tempb%
        ##2
        \fi
    }%
    #2%
    \let\@elt\@@elt
}

\newenvironment{btSect}[2][\bt@globalstyle]{%
    \ifx#1\@empty
        \PackageWarning{%
            bibtopic%
        }{%
            No \string\bibliographystyle\space given
            - \MessageBreak assuming `\bt@defaultstyle'%
        }%
        \def\bt@globalstyle{\bt@defaultstyle}%
    \fi
    \expandafter\ifx\csname bt@sect\romannumeral\bt@unit@cnt%
            \endcsname\relax
        \expandafter\protected@xdef\csname bt@sect\romannumeral%
            \bt@unit@cnt\endcsname{\bt@cited@list}%
    \fi
    \stepcounter{btauxfile}%
    \bt@info{bibliographystyle is `#1'\MessageBreak
            for file `\thebtauxfile .bbl'%
    }%
    \@bt@inside@sect@true
    \begin{bt@sect}{#1}{#2}%
}{%
    \end{bt@sect}%
}%
\newenvironment{btUnit}{%
    \if@bt@btunits@\else
    \PackageError{%
        bibtopic%
    }{%
        Use `btUnit' only togehter with the\MessageBreak
        `btunits' option%
    }{%
        When using the `btUnit' environment, you have to specify\MessageBreak
        the `btunits' package option for `bibtopic' as well.\MessageBreak

    }%
    \fi
    \if@bt@inside@unit@
    \PackageError{%
        bibtopic%
    }{%
        The `btUnit' environment cannot be nested%
    }{%
        You cannot open a `btUnit' environment inside another\MessageBreak
        `btUnit' environment.\MessageBreak
    }%
    \fi
    \global\@bt@inside@unit@true
    \if@bt@natbib@
    \else
        \bt@setcites
    \fi
    \if@bt@part@cont@ctr@
    \else
        \if@bt@natbib@
            \setcounter{NAT@ctr}{0}%
        \else
            \setcounter{enumiv}{0}% for standard styles
        \fi
    \fi
    \protected@xdef\the@ipfilectr{\bt@unit@cnt}%
    \immediate\write\@auxout{\string\bt@empty@list
                    \string\gdef\string\@extra@binfo{\@extra@b@citeb}}%
}{%
    \immediate\write\@auxout{\string\bt@save@list{\bt@unit@cnt}}
    \bt@stepcnt\bt@unit@cnt
    \gdef\the@ipfilectr{}%
    \immediate\write\@auxout{%
        \string\gdef\string\@extra@binfo{\@extra@b@citeb}}%
    \global\@bt@inside@unit@false
}
\newcommand*\btPrintCited{%
    \if@bt@inside@sect@
        \protected@edef\bt@curr@line{\the\inputlineno}%
        \def\bt@curr@cmd{\string\btPrintCited}%
        \bt@stepcnt\bt@internal@sect@cnt%
        \@bt@print@positive@true\@bt@print@all@false
        \label{Sec:\bt@internal@sect@cnt}%
        \bt@change@bibitem
        \bt@input@or@warn{\thebtauxfile}%
        \bt@print@keyvals{\bt@sect@ref@list}{%
            Sec:\bt@internal@sect@cnt
        }%
    \else
        \bt@sect@err{btSect}{\btPrintCited}%
    \fi
}
\newcommand*\btPrintNotCited{%
    \if@bt@inside@sect@
        \protected@edef\bt@curr@line{\the\inputlineno}%
        \def\bt@curr@cmd{\string\btPrintNotCited}%
        \bt@stepcnt\bt@internal@sect@cnt
        \@bt@print@positive@false\@bt@print@all@false
        \label{Sec:\bt@internal@sect@cnt}%
        \bt@change@bibitem
        \bt@input@or@warn{\thebtauxfile}%
    \else
        \bt@sect@err{btSect}{\btPrintNotCited}%
    \fi
}
\newcommand*\btPrintAll{%
    \if@bt@inside@sect@
        \protected@edef\bt@curr@line{\the\inputlineno}%
        \def\bt@curr@cmd{\string\btPrintAll}%
        \bt@stepcnt\bt@internal@sect@cnt
        \@bt@print@positive@false\@bt@print@all@true
        \label{Sec:\bt@internal@sect@cnt}%
        \bt@change@bibitem
        \bt@input@or@warn{\thebtauxfile}%
        \bt@print@keyvals{\bt@sect@ref@list}%
            {Sec:\bt@internal@sect@cnt}%
    \else
        \bt@sect@err{btSect}{\btPrintAll}%
    \fi
}
\newenvironment{bibtopics}[2]{%    [\bt@defaultstyle]{%
    \begin{btSect}[#1]{#2}%
    \btPrintAll
}{%
    \end{btSect}%
}
\newcommand\bt@bibstyle{}
\newcommand\bt@citation{}
\newcommand\bt@bibdata{}
\newenvironment{bibunit}[1][\bt@globalstyle]{%
    \ifx#1\@empty
        \PackageWarning{%
            bibtopic%
        }{%
            No \string\bibliographystyle\space given
            - \MessageBreak assuming `\bt@defaultstyle'%
        }%
        \def\bt@globalstyle{\bt@defaultstyle}%
    \fi
    \def\bt@bibstyle{#1}%
    \def\nocite##1{\def\bt@citation{##1}}%
    \def\cite##1{\def\bt@citation{##1}}%
    \gdef\putbib[##1]{\gdef\bt@bibdata{##1}}%
    \stepcounter{btauxfile}%
}{%
    \bt@change@thb
    \if@filesw
        \@bt@write@auxfile{\bt@bibstyle}{\bt@citation}{\bt@bibdata}%
    \fi
        \@bt@inside@sect@true
        \btPrintAll
}
\newcommand*\bt@bibitemcheck{%
    \if@bt@found@item@
    \else
        \PackageWarningNoLine{%
            bibtopic%
        }{%
            No appropriate bibitems found for command\MessageBreak %
            \bt@curr@cmd\space on line \bt@curr@line\MessageBreak %     
            (please see the section about `Warnings and error
             messages'\MessageBreak in `bibtopic.dvi' for details.)
        }%
    \fi
}
\newcommand*\bt@sect@err[2]{%
    \PackageError{%
        bibtopic%
    }{%
        You can't use `\string#2' outside of `#1'%
    }{%
        See the documentation on the `\string#2' command\MessageBreak
        in `bibtopic.dvi' for details.
    }%
}

\newcommand*\bt@bibtex@warning[1]{%
    \PackageWarningNoLine{%
        bibtopic%
    }{%
        Please (re)run BibTeX on the file(s):%
        \expandafter\MessageBreak#1%
        and after that rerun LaTeX%
    }%
}

\newcommand*\bt@files@warnings{%
    \ifnum\bt@harvard@errs > 0
        \PackageError{%
            bibtopic%
        }{%
            Your command \string\harvarditem\space was ignored%
        }{%
            `bibtopic' currently supports the `\string\harvarditem'
            command only\MessageBreak in connection with the `natbib'
            package. So either load this package,\MessageBreak or change
            the `\string\citationstyle' command to some non-harvard
            style.\MessageBreak If you hit <return> to continue, some of
            your bibliographies\MessageBreak will be empty.
        }%
    \fi
    \ifnum\bt@overridden@nums > 0
        \PackageWarningNoLine{%
            bibtopic%
        }{%
            The numerical argument in some `\string\bibitem'\MessageBreak
            commands has been ignored.\MessageBreak
            Using one of the package options\MessageBreak
            `overridenumbers' or `dontoverridenumbers'\MessageBreak
            will make this warning go away.\MessageBreak
            See the documentation on these options\MessageBreak
            in `bibtopic.dvi' for an explanation%
        }%
    \fi
    \if!\bt@warn@files!
        \relax
    \else
        \bt@mk@warning@list{\bt@warn@files}%
        \bt@bibtex@warning{\the\@temptokena}%
    \fi
}

\newcommand*\bt@input@or@warn[1]{%
    \IfFileExists{#1.bbl}%
    {%
        \input#1.bbl%
    }{%
        \bt@testelem{#1}{\bt@warn@files}%
        \if@bt@elem@
        \else
            \PackageWarningNoLine{%
                bibtopic%
            }{%
                No file #1.bbl%
            }%
            \if@bt@normalwarnings@
            \else
                \bt@append@list{#1}{\bt@warn@files}%
            \fi
        \fi
    }%
}%

\newcommand*\bt@warn@outd[1]{%
    \bt@testelem{#1}{\bt@warn@files}%
    \if@bt@elem@
    \else
        \bt@infoNoLine{Marking #1.bbl as outdated}%
        \bt@append@list{#1}{\bt@warn@files}%
    \fi
    \if@bt@natbib@\else
    \global\let\bt@item\relax
    \global\let\endbt@item\relax
    \fi
}%

\newcommand*\bt@warn@diff[1]{%
    \bt@testelem{#1}{\bt@warn@files}%
    \if@bt@elem@
    \else
        \if@bt@normalwarnings@
            \PackageWarningNoLine{%
                bibtopic%
            }{%
                #1.bbl may be outdated%
            }%
            %%% \bt@warn@outd{#1}%
        \else
            \bt@mark@as@outdated{#1}%
        \fi
    \fi
}%
\endinput
%%
%% End of file `bibtopic.sty'.
